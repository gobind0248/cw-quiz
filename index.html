<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JE-LDCE/DPQ MCQ Practice - Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ===== BASE STYLES ===== */
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
      min-height: 100vh;
      background-image: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* ===== FIXED HEADER ===== */
    .fixed-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: rgba(2, 6, 23, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
      z-index: 1000;
      padding: 12px 20px;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }

    .header-left {
      flex: 1;
      min-width: 0;
    }

    .header-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #e5e7eb;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .header-subtitle {
      font-size: 0.75rem;
      color: #9ca3af;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    .user-badge {
      font-size: 0.8rem;
      padding: 4px 12px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.1);
      color: #93c5fd;
      border: 1px solid rgba(37, 99, 235, 0.5);
      white-space: nowrap;
    }

    .logout-btn {
      background: rgba(239, 68, 68, 0.1);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.5);
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .logout-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      transform: translateY(-1px);
    }

    /* ===== LOGIN STYLES ===== */
    #login-container {
      width: 100%;
      max-width: 420px;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 60px; /* Account for fixed header */
    }

    .login-box {
      background: #020617;
      border-radius: 18px;
      padding: 30px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.3);
      width: 100%;
    }

    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .login-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: #e5e7eb;
      margin-bottom: 8px;
    }

    .login-subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      font-size: 0.9rem;
      color: #d1d5db;
      font-weight: 500;
    }

    .form-group input {
      background: #111827;
      color: #e5e7eb;
      border-radius: 10px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      padding: 12px 16px;
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .form-group input::placeholder {
      color: #6b7280;
    }

    .password-wrapper {
      position: relative;
    }

    .toggle-password {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 4px;
      font-size: 1rem;
    }

    .toggle-password:hover {
      color: #e5e7eb;
    }

    .login-btn {
      background: linear-gradient(to right, #3b82f6, #2563eb);
      color: white;
      border: none;
      border-radius: 999px;
      padding: 14px 24px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.4);
      width: 100%;
    }

    .login-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.5);
    }

    .login-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-loader {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: rgba(239, 68, 68, 0.1);
      color: #fca5a5;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      border: 1px solid rgba(239, 68, 68, 0.3);
      display: none;
    }

    .login-footer {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(75, 85, 99, 0.3);
      font-size: 0.85rem;
    }

    .attempts-counter {
      color: #9ca3af;
      text-align: center;
    }

    .attempts-counter span {
      color: #fbbf24;
      font-weight: 600;
    }

    .locked-message {
      background: rgba(245, 158, 11, 0.1);
      color: #fbbf24;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      border: 1px solid rgba(245, 158, 11, 0.3);
      margin-top: 20px;
    }

    .locked-message span {
      font-weight: 700;
      color: #f59e0b;
    }

    /* Shake animation for error */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .shake {
      animation: shake 0.5s ease-in-out;
    }

    /* ===== QUIZ STYLES ===== */
    .quiz-container {
      background: #020617;
      border-radius: 18px;
      padding: 20px 22px;
      max-width: 720px;
      width: 100%;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.3);
      display: none;
      margin: 80px 20px 20px; /* Top margin accounts for fixed header */
    }

    /* TOPIC SELECTION SECTION */
    .topic-section {
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 12px;
      border: 1px solid rgba(75, 85, 99, 0.5);
    }

    .topic-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .topic-name {
      font-size: 1rem;
      font-weight: 600;
      color: #3b82f6;
      background: rgba(59, 130, 246, 0.1);
      padding: 4px 12px;
      border-radius: 8px;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .question-count {
      font-size: 0.9rem;
      color: #22c55e;
      background: rgba(34, 197, 94, 0.1);
      padding: 4px 12px;
      border-radius: 8px;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .topic-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .topic-row label {
      font-size: 0.9rem;
      color: #d1d5db;
      white-space: nowrap;
    }

    .topic-select {
      background: #020617;
      color: #e5e7eb;
      border-radius: 8px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      padding: 8px 12px;
      font-size: 0.9rem;
      flex: 1;
      min-width: 200px;
    }

    .start-btn {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(to right, #3b82f6, #2563eb);
      color: white;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.4);
      white-space: nowrap;
    }

    .start-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.5);
    }

    /* RANDOMIZE TOGGLE */
    .toggle-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: #cbd5f5;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .toggle-row input {
      transform: scale(1.1);
      cursor: pointer;
      accent-color: #3b82f6;
    }

    .toggle-row label {
      cursor: pointer;
    }

    /* QUIZ CONTENT */
    .progress {
      margin-bottom: 16px;
      font-size: 0.85rem;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .progress-bar {
      flex: 1;
      height: 6px;
      background: #111827;
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, #22c55e, #3b82f6);
      transition: width 0.3s ease;
    }

    .question-box {
      background: #020617;
      border-radius: 14px;
      padding: 14px 14px 10px;
      border: 1px solid rgba(75, 85, 99, 0.7);
      margin-bottom: 16px;
      min-height: 140px;
    }

    .question-text {
      font-size: 0.98rem;
      font-weight: 500;
      color: #f9fafb;
      line-height: 1.5;
    }

    .options {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 8px;
      margin-top: 10px;
    }

    .option {
      border-radius: 12px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      padding: 8px 9px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.05s ease;
      font-size: 0.92rem;
      color: #e5e7eb;
    }

    .option:hover {
      background: rgba(31, 41, 55, 0.9);
      transform: translateY(-1px);
    }

    .option input {
      cursor: pointer;
      accent-color: #3b82f6;
    }

    .option.correct {
      background: rgba(22, 163, 74, 0.18);
      border-color: #22c55e;
    }

    .option.incorrect {
      background: rgba(220, 38, 38, 0.12);
      border-color: #f97373;
    }

    .option.disabled {
      pointer-events: none;
      opacity: 0.9;
    }

    .feedback {
      min-height: 22px;
      font-size: 0.9rem;
      margin-top: 6px;
    }

    .feedback.correct {
      color: #22c55e;
    }

    .feedback.incorrect {
      color: #fb7185;
    }

    /* TIMER CONTAINER */
    .timer-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px 12px;
      background: rgba(59, 130, 246, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .timer-label {
      font-size: 0.85rem;
      color: #93c5fd;
    }

    .timer-display {
      font-size: 1.1rem;
      font-weight: 700;
      color: #60a5fa;
      font-family: 'Courier New', monospace;
      letter-spacing: 1px;
    }

    .timer-warning {
      color: #fbbf24;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .timer-critical {
      color: #ef4444;
      animation: pulse 0.5s infinite;
    }

    .timer-notification {
      margin-bottom: 10px;
      padding: 8px 12px;
      background: rgba(245, 158, 11, 0.1);
      border-radius: 10px;
      border: 1px solid rgba(245, 158, 11, 0.3);
      font-size: 0.85rem;
      color: #fbbf24;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* CONTROLS LAYOUT */
    .controls {
      margin-top: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .left-controls {
      display: flex;
      gap: 10px;
      justify-content: flex-start;
      flex: 1;
    }

    .right-controls {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex: 1;
    }

    button {
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.1s ease;
    }

    #previous-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      background: #1f2937;
      color: #e5e7eb;
      border: 1px solid rgba(75, 85, 99, 0.8);
      min-width: 120px;
    }

    #previous-btn:hover:enabled {
      background: #111827;
    }

    #previous-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #next-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      background: #1f2937;
      color: #e5e7eb;
      border: 1px solid rgba(75, 85, 99, 0.8);
      min-width: 120px;
    }

    #next-btn:hover:enabled {
      background: #111827;
    }

    #next-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #submit-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(to right, #22c55e, #16a34a);
      color: white;
      box-shadow: 0 8px 18px rgba(34, 197, 94, 0.4);
      min-width: 120px;
    }

    #submit-btn:hover:enabled {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(34, 197, 94, 0.5);
    }

    #submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #finish-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(to right, #f59e0b, #d97706);
      color: white;
      box-shadow: 0 8px 18px rgba(245, 158, 11, 0.4);
      min-width: 120px;
    }

    #finish-btn:hover:enabled {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(245, 158, 11, 0.5);
    }

    #finish-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .score-box {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .final-score {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.8);
      font-size: 0.95rem;
    }

    .final-score strong {
      color: #22c55e;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }

    /* RESPONSIVE STYLES */
    @media (max-width: 700px) {
      body {
        padding: 15px;
        justify-content: flex-start;
      }
      
      .fixed-header {
        padding: 10px 15px;
      }
      
      .header-content {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .header-right {
        width: 100%;
        justify-content: space-between;
      }
      
      #login-container, .quiz-container {
        margin: 70px auto 20px;
        width: 95%;
      }
      
      .quiz-container {
        padding: 15px;
      }
      
      .login-box {
        padding: 20px;
      }
      
      .controls {
        flex-direction: column;
        gap: 8px;
      }
      
      .left-controls, .right-controls {
        width: 100%;
        justify-content: center;
      }
      
      button {
        flex: 1;
        min-width: 0;
      }
      
      .topic-info {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .topic-name, .question-count {
        width: 100%;
        text-align: center;
      }
      
      .topic-row {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .topic-row label,
      .topic-row .topic-select,
      .topic-row .start-btn {
        width: 100%;
      }
      
      .topic-select {
        min-width: 0;
        width: 100%;
      }
      
      .start-btn {
        width: 100%;
      }
      
      .timer-container {
        flex-direction: column;
        gap: 5px;
        align-items: flex-start;
      }
      
      #login-container {
        padding: 15px;
      }
      
      .login-footer {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }
    }

    @media (min-width: 701px) {
      body {
        padding: 40px 20px;
      }
      
      #login-container, .quiz-container {
        margin: 80px auto 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Fixed Header -->
  <div class="fixed-header" style="display: none;">
    <div class="header-content">
      <div class="header-left">
        <div class="header-title">DPQ / LDCE (JE Examination)</div>
        <div class="header-subtitle">Created By Gobind Sharma ‚Ä¢ Logged in as: <span id="header-logged-in-user">Guest</span></div>
      </div>
      <div class="header-right">
        <div class="user-badge" id="header-topic-badge">No topic selected</div>
        <button class="logout-btn" id="header-logout-btn">Logout</button>
      </div>
    </div>
  </div>
  
  <!-- Login Container (shown by default) -->
  <div id="login-container"></div>
  
  <!-- Quiz Container (hidden by default, shown after login) -->
  <div class="quiz-container">
    <!-- TOPIC SELECTION SECTION -->
    <div class="topic-section">
      <div class="topic-info">
        <div class="topic-name" id="quiz-topic-name">No topic selected</div>
        <div class="question-count" id="quiz-question-count">0 questions</div>
      </div>
      
      <div class="topic-row">
        <label for="topic-select">Select Topic:</label>
        <select id="topic-select" class="topic-select">
          <option value="">Loading topics...</option>
        </select>
        <button class="start-btn" id="start-btn" disabled>Load Topic</button>
      </div>
    </div>

    <!-- Timer Container -->
    <div id="timer-container" class="timer-container" style="display: none;">
      <div class="timer-label">‚è∞ Time Remaining:</div>
      <div id="timer-display" class="timer-display">00:00:00</div>
    </div>

    <!-- RANDOMIZE TOGGLE -->
    <div class="toggle-row">
      <input type="checkbox" id="random-toggle" checked />
      <label for="random-toggle">Randomize questions & options</label>
    </div>

    <div class="progress">
      <div id="question-counter">Select a topic and click Load Topic</div>
      <div class="progress-bar">
        <div id="progress-bar-fill" class="progress-bar-fill"></div>
      </div>
      <div id="score-mini">Score: 0</div>
    </div>

    <div class="question-box">
      <div id="question-text" class="question-text">
        Please login to access the quiz.
      </div>
      <ul id="options-list" class="options"></ul>
      <div id="feedback" class="feedback"></div>
    </div>

    <!-- BUTTON LAYOUT -->
    <div class="controls">
      <div class="left-controls">
        <button id="previous-btn" disabled>‚Üê Previous</button>
        <button id="next-btn" disabled>Next ‚Üí</button>
      </div>
      <div class="right-controls">
        <button id="submit-btn" disabled>Submit</button>
        <button id="finish-btn" disabled>Finish</button>
      </div>
    </div>

    <div class="score-box">
      <div id="final-score" class="final-score" style="display:none;"></div>
    </div>
  </div>

  <!-- Load login system first -->
  <script>
    // ========= LOGIN SYSTEM =========
    const LOGIN_SHEET_GID = "1362508814";
    const BASE_SHEET_ID = "1hJSzOmZZilf3XR4SxlM-s_xPoq-4KkQKJ9vF8TGxSn4";

    class QuizLogin {
        constructor() {
            this.isAuthenticated = false;
            this.currentUser = null;
            this.loginAttempts = 0;
            this.maxAttempts = 3;
            this.lockDuration = 30000;
            
            this.fixedHeader = null;
            this.headerLoggedInUserEl = null;
            this.headerTopicBadgeEl = null;
            this.headerLogoutBtn = null;
            this.loginContainer = null;
            this.quizContainer = null;
            this.loginForm = null;
            this.usernameInput = null;
            this.passwordInput = null;
            this.loginBtn = null;
            this.logoutBtn = null;
            this.loggedInUserEl = null;
            this.errorMsg = null;
            this.lockedUntil = null;
            
            this.init();
        }

        init() {
            this.createLoginUI();
            this.checkSession();
            this.attachEventListeners();
        }

        createLoginUI() {
            // Create login container
            this.loginContainer = document.createElement('div');
            this.loginContainer.id = 'login-container';
            this.loginContainer.innerHTML = `
                <div class="login-box">
                    <div class="login-header">
                        <div class="login-title">üîê JE DPQ / LDCE Login</div>
                        <div class="login-subtitle">Enter your credentials to access</div>
                    </div>
                    
                    <form id="login-form" class="login-form">
                        <div class="form-group">
                            <label for="username">Username</label>
                            <input type="text" id="username" name="username" required 
                                   placeholder="Enter your username" autocomplete="username">
                        </div>
                        
                        <div class="form-group">
                            <label for="password">Password</label>
                            <div class="password-wrapper">
                                <input type="password" id="password" name="password" required 
                                       placeholder="Enter your password" autocomplete="current-password">
                                <button type="button" class="toggle-password" id="toggle-password">üëÅÔ∏è</button>
                            </div>
                        </div>
                        
                        <div id="login-error" class="error-message"></div>
                        
                        <div class="form-group">
                            <button type="submit" id="login-btn" class="login-btn">
                                <span class="btn-text">Login</span>
                                <span class="btn-loader" style="display: none;">
                                    <div class="spinner"></div> Verifying...
                                </span>
                            </button>
                        </div>
                    </form>
                    
                    <div class="login-footer">
                        <div class="attempts-counter" id="attempts-counter">
                            Attempts: <span id="attempts-count">0</span>/3
                        </div>
                    </div>
                    
                    <div id="locked-message" class="locked-message" style="display: none;">
                        ‚ö†Ô∏è Account locked. Try again in <span id="lock-timer">30</span> seconds
                    </div>
                </div>
            `;

            // Get existing containers
            this.quizContainer = document.querySelector('.quiz-container');
            this.fixedHeader = document.querySelector('.fixed-header');
            
            if (this.quizContainer) {
                this.quizContainer.style.display = 'none';
                document.body.insertBefore(this.loginContainer, this.quizContainer);
            }

            // Cache DOM elements
            this.loginForm = document.getElementById('login-form');
            this.usernameInput = document.getElementById('username');
            this.passwordInput = document.getElementById('password');
            this.loginBtn = document.getElementById('login-btn');
            this.errorMsg = document.getElementById('login-error');
            this.attemptsCount = document.getElementById('attempts-count');
            this.togglePasswordBtn = document.getElementById('toggle-password');
            this.lockedMessage = document.getElementById('locked-message');
            this.lockTimer = document.getElementById('lock-timer');
            
            // Get header elements
            this.headerLoggedInUserEl = document.getElementById('header-logged-in-user');
            this.headerTopicBadgeEl = document.getElementById('header-topic-badge');
            this.headerLogoutBtn = document.getElementById('header-logout-btn');
        }

        attachEventListeners() {
            // Login form submission
            this.loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleLogin();
            });

            // Toggle password visibility
            this.togglePasswordBtn.addEventListener('click', () => {
                const type = this.passwordInput.type === 'password' ? 'text' : 'password';
                this.passwordInput.type = type;
                this.togglePasswordBtn.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è';
            });

            // Clear error on input
            this.usernameInput.addEventListener('input', () => this.clearError());
            this.passwordInput.addEventListener('input', () => this.clearError());

            // Add logout button event listener
            if (this.headerLogoutBtn) {
                this.headerLogoutBtn.addEventListener('click', () => this.handleLogout());
            }
        }

        async handleLogin() {
            // Check if account is locked
            if (this.lockedUntil && Date.now() < this.lockedUntil) {
                const remaining = Math.ceil((this.lockedUntil - Date.now()) / 1000);
                this.showError(`Account locked. Try again in ${remaining} seconds.`);
                this.showLockedMessage(remaining);
                return;
            }

            const username = this.usernameInput.value.trim();
            const password = this.passwordInput.value.trim();

            if (!username || !password) {
                this.showError('Please enter both username and password');
                return;
            }

            // Show loading state
            this.setLoading(true);

            try {
                const isValid = await this.validateCredentials(username, password);
                
                if (isValid) {
                    // Login successful
                    this.loginAttempts = 0;
                    this.isAuthenticated = true;
                    this.currentUser = username;
                    
                    // Save session
                    this.saveSession(username);
                    
                    // Show success message
                    this.showSuccess('Login successful! Redirecting...');
                    
                    // Switch to quiz after delay
                    setTimeout(() => {
                        this.showQuiz();
                    }, 1000);
                } else {
                    // Login failed
                    this.loginAttempts++;
                    this.attemptsCount.textContent = this.loginAttempts;
                    
                    if (this.loginAttempts >= this.maxAttempts) {
                        // Lock account
                        this.lockedUntil = Date.now() + this.lockDuration;
                        this.showError(`Too many failed attempts. Account locked for 30 seconds.`);
                        this.showLockedMessage(30);
                        
                        // Start lock timer
                        this.startLockTimer();
                    } else {
                        this.showError(`Invalid credentials. Attempts: ${this.loginAttempts}/${this.maxAttempts}`);
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                this.showError('Network error. Please check your connection.');
            } finally {
                this.setLoading(false);
            }
        }

        async validateCredentials(username, password) {
            try {
                // Fetch login credentials from Google Sheet
                const url = `https://docs.google.com/spreadsheets/d/${BASE_SHEET_ID}/export?format=csv&gid=${LOGIN_SHEET_GID}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch credentials');
                }
                
                const csvText = await response.text();
                const credentials = this.parseCredentialsCSV(csvText);
                
                // Check if username and password match
                return credentials.some(cred => 
                    cred.username === username && cred.password === password
                );
            } catch (error) {
                console.error('Error validating credentials:', error);
                
                // Fallback: Check against demo credentials if sheet fails
                const demoCredentials = [
                    { username: 'User1', password: 'Pass123' },
                    { username: 'User2', password: 'Pass456' },
                    { username: 'Admin', password: 'Admin123' }
                ];
                
                return demoCredentials.some(cred => 
                    cred.username === username && cred.password === password
                );
            }
        }

        parseCredentialsCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const credentials = [];
            
            // Skip header row
            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);
                
                if (row.length >= 2) {
                    const username = row[0] ? row[0].replace(/^"|"$/g, '').trim() : '';
                    const password = row[1] ? row[1].replace(/^"|"$/g, '').trim() : '';
                    
                    if (username && password) {
                        credentials.push({ username, password });
                    }
                }
            }
            
            return credentials;
        }

        showQuiz() {
            this.loginContainer.style.display = 'none';
            this.fixedHeader.style.display = 'block';
            this.quizContainer.style.display = 'block';
            
            // Update the header with logged in user
            if (this.headerLoggedInUserEl) {
                this.headerLoggedInUserEl.textContent = this.currentUser;
            }
            
            // Initialize quiz
            if (window.initializeApp) {
                window.initializeApp();
            }
        }

        handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                this.isAuthenticated = false;
                this.currentUser = null;
                
                // Clear session
                this.clearSession();
                
                // Reset login form
                this.loginForm.reset();
                this.loginAttempts = 0;
                this.attemptsCount.textContent = '0';
                this.clearError();
                this.hideLockedMessage();
                
                // Hide fixed header and quiz, show login
                this.fixedHeader.style.display = 'none';
                this.quizContainer.style.display = 'none';
                this.loginContainer.style.display = 'block';
                
                // Reset header display
                if (this.headerLoggedInUserEl) {
                    this.headerLoggedInUserEl.textContent = 'Guest';
                }
                if (this.headerTopicBadgeEl) {
                    this.headerTopicBadgeEl.textContent = 'No topic selected';
                }
                
                // Reset quiz state
                if (window.resetQuizState) {
                    window.resetQuizState();
                }
            }
        }

        saveSession(username) {
            const session = {
                username,
                timestamp: Date.now(),
                expires: Date.now() + (24 * 60 * 60 * 1000) // 24 hours
            };
            localStorage.setItem('cwje_quiz_session', JSON.stringify(session));
        }

        checkSession() {
            try {
                const sessionStr = localStorage.getItem('cwje_quiz_session');
                if (sessionStr) {
                    const session = JSON.parse(sessionStr);
                    
                    if (session.expires > Date.now()) {
                        // Session is valid
                        this.isAuthenticated = true;
                        this.currentUser = session.username;
                        
                        // Update header with logged in user
                        if (this.headerLoggedInUserEl) {
                            this.headerLoggedInUserEl.textContent = this.currentUser;
                        }
                        
                        this.showQuiz();
                    } else {
                        // Session expired
                        this.clearSession();
                    }
                }
            } catch (error) {
                console.error('Error checking session:', error);
                this.clearSession();
            }
        }

        clearSession() {
            localStorage.removeItem('cwje_quiz_session');
        }

        showError(message) {
            this.errorMsg.textContent = message;
            this.errorMsg.style.display = 'block';
            
            // Shake animation for error
            this.loginForm.classList.add('shake');
            setTimeout(() => {
                this.loginForm.classList.remove('shake');
            }, 500);
        }

        showSuccess(message) {
            this.errorMsg.textContent = message;
            this.errorMsg.style.color = '#22c55e';
            this.errorMsg.style.display = 'block';
        }

        clearError() {
            this.errorMsg.textContent = '';
            this.errorMsg.style.display = 'none';
            this.errorMsg.style.color = '#ef4444';
        }

        setLoading(isLoading) {
            const btnText = this.loginBtn.querySelector('.btn-text');
            const btnLoader = this.loginBtn.querySelector('.btn-loader');
            
            if (isLoading) {
                btnText.style.display = 'none';
                btnLoader.style.display = 'inline-flex';
                this.loginBtn.disabled = true;
            } else {
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
                this.loginBtn.disabled = false;
            }
        }

        showLockedMessage(seconds) {
            this.lockedMessage.style.display = 'block';
            this.lockTimer.textContent = seconds;
            this.loginForm.style.display = 'none';
        }

        hideLockedMessage() {
            this.lockedMessage.style.display = 'none';
            this.loginForm.style.display = 'block';
        }

        startLockTimer() {
            const updateTimer = () => {
                const remaining = Math.ceil((this.lockedUntil - Date.now()) / 1000);
                
                if (remaining > 0) {
                    this.lockTimer.textContent = remaining;
                    setTimeout(updateTimer, 1000);
                } else {
                    // Lock expired
                    this.hideLockedMessage();
                    this.lockedUntil = null;
                    this.loginAttempts = 0;
                    this.attemptsCount.textContent = '0';
                    this.clearError();
                }
            };
            
            updateTimer();
        }
        
        updateTopicBadge(topicName, questionCount) {
            if (this.headerTopicBadgeEl) {
                this.headerTopicBadgeEl.textContent = `${topicName} (${questionCount} Q)`;
            }
        }
    }
  </script>
  
  <!-- Then load the quiz logic -->
  <script>
    // ========= GLOBAL VARIABLES =========
    let topicsData = null;
    let BASE_ID = "1hJSzOmZZilf3XR4SxlM-s_xPoq-4KkQKJ9vF8TGxSn4";
    let TOPICS = {};

    let questions = [];
    let currentIndex = 0;
    let score = 0;
    let hasAnswered = false;
    let questionsLoaded = false;
    let currentTopicKey = null;
    let userAnswers = [];
    let topicTimeLimit = 0;
    let timeRemaining = 0;
    let timerInterval = null;
    let timeLimitSet = false;
    let timerNotification = null;

    const questionTextEl    = document.getElementById("question-text");
    const optionsListEl     = document.getElementById("options-list");
    const feedbackEl        = document.getElementById("feedback");
    const submitBtn         = document.getElementById("submit-btn");
    const nextBtn           = document.getElementById("next-btn");
    const previousBtn       = document.getElementById("previous-btn");
    const finishBtn         = document.getElementById("finish-btn");
    const questionCounterEl = document.getElementById("question-counter");
    const progressBarFillEl = document.getElementById("progress-bar-fill");
    const scoreMiniEl       = document.getElementById("score-mini");
    const finalScoreEl      = document.getElementById("final-score");
    const topicSelectEl     = document.getElementById("topic-select");
    const startBtnEl        = document.getElementById("start-btn");
    const timerContainerEl  = document.getElementById("timer-container");
    const timerDisplayEl    = document.getElementById("timer-display");
    const randomToggleEl    = document.getElementById("random-toggle");
    const quizTopicNameEl   = document.getElementById("quiz-topic-name");
    const quizQuestionCountEl = document.getElementById("quiz-question-count");

    // Function to reset quiz state (used by logout)
    window.resetQuizState = function() {
      questions = [];
      currentIndex = 0;
      score = 0;
      hasAnswered = false;
      questionsLoaded = false;
      currentTopicKey = null;
      userAnswers = [];
      topicTimeLimit = 0;
      timeRemaining = 0;
      timeLimitSet = false;
      
      // Stop any running timer
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      
      // Reset UI
      topicSelectEl.innerHTML = '<option value="">-- Choose Topic --</option>';
      topicSelectEl.disabled = false;
      startBtnEl.disabled = false;
      questionTextEl.textContent = "Please login to access the quiz.";
      optionsListEl.innerHTML = "";
      feedbackEl.textContent = "";
      submitBtn.disabled = true;
      nextBtn.disabled = true;
      previousBtn.disabled = true;
      finishBtn.disabled = true;
      questionCounterEl.textContent = "Select a topic and click Load Topic";
      progressBarFillEl.style.width = "0%";
      scoreMiniEl.textContent = "Score: 0";
      finalScoreEl.style.display = "none";
      timerContainerEl.style.display = "none";
      quizTopicNameEl.textContent = "No topic selected";
      quizQuestionCountEl.textContent = "0 questions";
      
      // Remove timer notification if exists
      if (timerNotification && timerNotification.parentNode) {
        timerNotification.parentNode.removeChild(timerNotification);
        timerNotification = null;
      }
      
      // Update header badge
      if (window.quizLogin && window.quizLogin.updateTopicBadge) {
        window.quizLogin.updateTopicBadge("No topic selected", 0);
      }
    };

    // ---------- Initialize App ----------

    async function initializeApp() {
      try {
        // Load topics from JSON file
        const response = await fetch('topics.json');
        if (!response.ok) throw new Error('Failed to load topics.json');
        
        topicsData = await response.json();
        BASE_ID = topicsData.base_sheet_id;
        
        // Build TOPICS object from JSON data
        TOPICS = {};
        topicsData.topics.forEach(topic => {
          TOPICS[topic.id] = {
            name: topic.name,
            url: `https://docs.google.com/spreadsheets/d/${BASE_ID}/export?format=csv&gid=${topic.gid}`
          };
        });
        
        // Populate topic dropdown
        populateTopicDropdown();
        
        // Enable start button
        startBtnEl.disabled = false;
        
      } catch (error) {
        console.error('Error loading topics:', error);
        topicSelectEl.innerHTML = '<option value="">Error loading topics</option>';
        questionTextEl.textContent = "Error loading topics. Please check if topics.json file exists.";
      }
    }

    function populateTopicDropdown() {
      topicSelectEl.innerHTML = '<option value="">-- Choose Topic --</option>';
      
      topicsData.topics.forEach(topic => {
        const option = document.createElement('option');
        option.value = topic.id;
        option.textContent = topic.name;
        topicSelectEl.appendChild(option);
      });
    }

    // ---------- Timer Functions ----------

    function startTopicTimer() {
      if (!timeLimitSet || topicTimeLimit <= 0) return;
      
      timeRemaining = topicTimeLimit * 60 * 1000;
      timerContainerEl.style.display = "flex";
      
      updateTimerDisplay();
      
      timerInterval = setInterval(() => {
        timeRemaining -= 1000;
        
        if (timeRemaining <= 0) {
          timeRemaining = 0;
          clearInterval(timerInterval);
          autoFinishQuiz();
        }
        
        updateTimerDisplay();
      }, 1000);
    }

    function updateTimerDisplay() {
      const hours = Math.floor(timeRemaining / (1000 * 60 * 60));
      const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);
      
      const formattedTime = 
        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      timerDisplayEl.textContent = formattedTime;
      
      updateTimerLabel(hours, minutes);
      
      timerDisplayEl.classList.remove("timer-warning", "timer-critical");
      
      const warningThreshold = topicTimeLimit * 60 * 1000 * 0.25;
      
      if (timeRemaining <= warningThreshold && timeRemaining > 0) {
        timerDisplayEl.classList.add("timer-warning");
      }
      
      const criticalThreshold = Math.min(topicTimeLimit * 60 * 1000 * 0.10, 5 * 60 * 1000);
      
      if (timeRemaining <= criticalThreshold && timeRemaining > 0) {
        timerDisplayEl.classList.add("timer-critical");
      }
    }

    function updateTimerLabel(hours, minutes) {
      const timerLabel = timerContainerEl.querySelector('.timer-label');
      const totalMinutes = hours * 60 + minutes;
      
      if (totalMinutes <= 5) {
        timerLabel.textContent = "‚è∞ Hurry! Time almost up:";
        timerLabel.style.color = "#f87171";
      } else if (totalMinutes <= 15) {
        timerLabel.textContent = "‚è∞ Time running out:";
        timerLabel.style.color = "#fbbf24";
      } else {
        timerLabel.textContent = "‚è∞ Time Remaining:";
        timerLabel.style.color = "#93c5fd";
      }
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      timerContainerEl.style.display = "none";
    }

    function showTimerNotification() {
      removeTimerNotification();
      
      if (timeLimitSet && topicTimeLimit > 0) {
        timerNotification = document.createElement("div");
        timerNotification.className = "timer-notification";
        timerNotification.innerHTML = `
          <span>‚è∞</span>
          <span>Timer set: <strong>${topicTimeLimit} minutes</strong> for this quiz</span>
        `;
        
        const questionBox = document.querySelector(".question-box");
        questionBox.parentNode.insertBefore(timerNotification, questionBox);
      }
    }

    function removeTimerNotification() {
      if (timerNotification && timerNotification.parentNode) {
        timerNotification.parentNode.removeChild(timerNotification);
        timerNotification = null;
      }
      
      const existingNotifications = document.querySelectorAll(".timer-notification");
      existingNotifications.forEach(notification => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      });
    }

    function autoFinishQuiz() {
      if (!timeLimitSet) return;
      
      const timeUpMessage = document.createElement("div");
      timeUpMessage.className = "final-score";
      timeUpMessage.style.backgroundColor = "rgba(239, 68, 68, 0.1)";
      timeUpMessage.style.borderColor = "rgba(239, 68, 68, 0.5)";
      timeUpMessage.innerHTML = `
        <strong style="color: #ef4444;">‚è∞ Time's Up!</strong><br/>
        Your ${topicTimeLimit}-minute time limit has expired.<br/><br/>
      `;
      
      finalScoreEl.parentNode.insertBefore(timeUpMessage, finalScoreEl);
      
      showFinalResults();
      
      stopTimer();
      removeTimerNotification();
    }

    // ---------- CSV Parsing & Question Management ----------

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function parseCSV(text) {
      const lines = text.trim().split("\n");
      const result = [];
      if (lines.length <= 1) return result;

      const headers = lines[0].toLowerCase().split(',');
      
      const questionIndex = headers.findIndex(h => h.includes('question'));
      const option1Index = headers.findIndex(h => h.includes('option1') || h.includes('option 1'));
      const option2Index = headers.findIndex(h => h.includes('option2') || h.includes('option 2'));
      const option3Index = headers.findIndex(h => h.includes('option3') || h.includes('option 3'));
      const option4Index = headers.findIndex(h => h.includes('option4') || h.includes('option 4'));
      const correctIndex = headers.findIndex(h => h.includes('correct'));
      const timeIndex = headers.findIndex(h => h.includes('time'));
      
      topicTimeLimit = 0;
      timeLimitSet = false;

      for (let i = 1; i < lines.length; i++) {
        const row = lines[i].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);
        
        if (i === 1 && timeIndex >= 0 && timeIndex < row.length) {
          const timeValue = row[timeIndex].replace(/^"|"$/g, "").trim();
          if (timeValue && !isNaN(parseFloat(timeValue))) {
            topicTimeLimit = parseFloat(timeValue);
            timeLimitSet = true;
          }
        }
        
        if (row.length < Math.max(questionIndex, option1Index, option2Index, option3Index, option4Index, correctIndex) + 1) {
          continue;
        }

        const q   = row[questionIndex] ? row[questionIndex].replace(/^"|"$/g, "").trim() : "";
        const o1  = row[option1Index] ? row[option1Index].replace(/^"|"$/g, "").trim() : "";
        const o2  = row[option2Index] ? row[option2Index].replace(/^"|"$/g, "").trim() : "";
        const o3  = row[option3Index] ? row[option3Index].replace(/^"|"$/g, "").trim() : "";
        const o4  = row[option4Index] ? row[option4Index].replace(/^"|"$/g, "").trim() : "";
        const raw = row[correctIndex] ? row[correctIndex].replace(/^"|"$/g, "").trim() : "";

        if (!q) continue;

        let correctIdx = 0;
        if (/^[1-4]$/.test(raw)) {
          correctIdx = parseInt(raw, 10) - 1;
        } else {
          const map = { A:0, B:1, C:2, D:3 };
          correctIdx = map[raw.toUpperCase()] ?? 0;
        }

        result.push({
          question: q,
          options: [o1, o2, o3, o4],
          correctIndex: correctIdx
        });
      }
      
      return result;
    }

    function prepareQuestionBank(rawQuestions) {
      const qs = rawQuestions.map(q => ({
        question: q.question,
        options: [...q.options],
        correctIndex: q.correctIndex
      }));

      // Only shuffle questions if random toggle is checked
      if (randomToggleEl.checked) {
        shuffleArray(qs);
        
        qs.forEach(q => {
          const idxs = [0, 1, 2, 3];
          shuffleArray(idxs);
          const newOptions = idxs.map(i => q.options[i]);
          const newCorrectIndex = idxs.indexOf(q.correctIndex);
          q.options = newOptions;
          q.correctIndex = newCorrectIndex;
        });
      }

      return qs;
    }

    // ---------- UI rendering ----------

    function renderQuestion() {
      if (!questionsLoaded || questions.length === 0) {
        questionTextEl.textContent = "No questions available. Check your Google Sheet.";
        optionsListEl.innerHTML = "";
        submitBtn.disabled = true;
        nextBtn.disabled = true;
        previousBtn.disabled = true;
        finishBtn.disabled = true;
        return;
      }

      const q = questions[currentIndex];
      hasAnswered = false;
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";
      finalScoreEl.style.display = "none";

      questionCounterEl.textContent = `Question ${currentIndex + 1} / ${questions.length}`;
      const progressPercent = (currentIndex / questions.length) * 100;
      progressBarFillEl.style.width = `${progressPercent}%`;

      questionTextEl.textContent = q.question;
      optionsListEl.innerHTML = "";

      q.options.forEach((opt, idx) => {
        const li = document.createElement("li");
        li.className = "option";

        const input = document.createElement("input");
        input.type = "radio";
        input.name = "option";
        input.value = idx;
        input.id = `opt-${idx}`;

        if (userAnswers[currentIndex] !== undefined) {
          input.checked = (userAnswers[currentIndex] === idx);
        }

        const label = document.createElement("label");
        label.setAttribute("for", `opt-${idx}`);
        label.textContent = opt;

        li.appendChild(input);
        li.appendChild(label);
        optionsListEl.appendChild(li);

        li.addEventListener("click", () => {
          const radio = li.querySelector("input");
          if (radio) {
            radio.checked = true;
            userAnswers[currentIndex] = idx;
          }
        });
      });

      submitBtn.disabled = false;
      submitBtn.textContent = "Submit";
      previousBtn.disabled = (currentIndex === 0);
      nextBtn.disabled = false;
      finishBtn.disabled = false;
      
      if (userAnswers[currentIndex] !== undefined) {
        const selectedIndex = userAnswers[currentIndex];
        const isCorrect = (selectedIndex === q.correctIndex);
        
        showCorrectness(selectedIndex);
        lockOptions();
        submitBtn.disabled = true;
        hasAnswered = true;
        
        if (isCorrect) {
          feedbackEl.textContent = "‚úÖ Correct!";
          feedbackEl.className = "feedback correct";
        } else {
          feedbackEl.textContent = `‚ùå Wrong. Correct answer: ${q.options[q.correctIndex]}`;
          feedbackEl.className = "feedback incorrect";
        }
      } else {
        feedbackEl.textContent = "";
      }
    }

    function getSelectedOptionIndex() {
      const radios = document.querySelectorAll("input[name='option']");
      for (let r of radios) {
        if (r.checked) return parseInt(r.value, 10);
      }
      return -1;
    }

    function lockOptions() {
      const optionEls = document.querySelectorAll(".option");
      optionEls.forEach(opt => {
        opt.classList.add("disabled");
        const input = opt.querySelector("input");
        if (input) input.disabled = true;
      });
    }

    function showCorrectness(selectedIndex) {
      const q = questions[currentIndex];
      const optionEls = document.querySelectorAll(".option");
      optionEls.forEach((optEl, idx) => {
        optEl.classList.remove("correct", "incorrect");
        if (idx === q.correctIndex) optEl.classList.add("correct");
        if (idx === selectedIndex && selectedIndex !== q.correctIndex) {
          optEl.classList.add("incorrect");
        }
      });
    }

    function goToNextQuestion() {
      if (currentIndex < questions.length - 1) {
        currentIndex++;
        renderQuestion();
      } else {
        showFinalResults();
      }
    }

    function goToPreviousQuestion() {
      if (currentIndex > 0) {
        currentIndex--;
        renderQuestion();
      }
    }

    function showFinalResults() {
      stopTimer();
      removeTimerNotification();
      
      let finalScore = 0;
      for (let i = 0; i < questions.length; i++) {
        if (userAnswers[i] !== undefined && userAnswers[i] === questions[i].correctIndex) {
          finalScore++;
        }
      }
      
      progressBarFillEl.style.width = "100%";
      questionTextEl.textContent = "Quiz Completed!";
      optionsListEl.innerHTML = "";
      feedbackEl.textContent = "";
      submitBtn.style.display = "none";
      nextBtn.style.display = "none";
      previousBtn.style.display = "none";
      finishBtn.style.display = "none";
      finalScoreEl.style.display = "block";
      
      const timerInfo = timeLimitSet ? 
        `<br/><small style="color: #9ca3af;">Time limit: ${topicTimeLimit} minutes | ${formatTimeTaken()}</small>` : '';
      
      finalScoreEl.innerHTML = `
        <strong>Result:</strong> You scored <strong>${finalScore}</strong> out of <strong>${questions.length}</strong>.${timerInfo}<br/>
        Each question = 1 mark.<br/><br/>
        <button id="restart-btn" style="margin-right: 10px; background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 999px; cursor: pointer;">Restart Same Topic</button>
        <button id="new-topic-btn" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 999px; cursor: pointer;">Choose New Topic</button>
      `;
      
      document.getElementById("restart-btn").onclick = () => {
        restartQuiz();
      };
      
      document.getElementById("new-topic-btn").onclick = () => {
        resetQuizUI();
        stopTimer();
        removeTimerNotification();
      };
    }

    function formatTimeTaken() {
      if (!timeLimitSet) return "";
      
      const timeTaken = topicTimeLimit * 60 * 1000 - timeRemaining;
      const hours = Math.floor(timeTaken / (1000 * 60 * 60));
      const minutes = Math.floor((timeTaken % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((timeTaken % (1000 * 60)) / 1000);
      
      if (hours > 0) {
        return `Time taken: ${hours}h ${minutes}m ${seconds}s`;
      } else if (minutes > 0) {
        return `Time taken: ${minutes}m ${seconds}s`;
      } else {
        return `Time taken: ${seconds}s`;
      }
    }

    function resetQuizUI() {
      topicSelectEl.value = "";
      quizTopicNameEl.textContent = "No topic selected";
      quizQuestionCountEl.textContent = "0 questions";
      questionTextEl.textContent = "Select a topic and start quiz";
      optionsListEl.innerHTML = "";
      feedbackEl.textContent = "";
      submitBtn.style.display = "inline-block";
      nextBtn.style.display = "inline-block";
      previousBtn.style.display = "inline-block";
      finishBtn.style.display = "inline-block";
      finalScoreEl.style.display = "none";
      progressBarFillEl.style.width = "0%";
      questionCounterEl.textContent = "Select a topic and click Load Topic";
      scoreMiniEl.textContent = "Score: 0";
      
      questions = [];
      currentIndex = 0;
      score = 0;
      hasAnswered = false;
      questionsLoaded = false;
      currentTopicKey = null;
      userAnswers = [];
      topicTimeLimit = 0;
      timeRemaining = 0;
      timeLimitSet = false;
      
      // Update header badge
      if (window.quizLogin && window.quizLogin.updateTopicBadge) {
        window.quizLogin.updateTopicBadge("No topic selected", 0);
      }
    }

    function restartQuiz() {
      score = 0;
      currentIndex = 0;
      userAnswers = [];
      scoreMiniEl.textContent = "Score: 0";
      submitBtn.style.display = "inline-block";
      nextBtn.style.display = "inline-block";
      previousBtn.style.display = "inline-block";
      finishBtn.style.display = "inline-block";
      finalScoreEl.style.display = "none";
      
      if (timeLimitSet && topicTimeLimit > 0) {
        startTopicTimer();
        showTimerNotification();
      }
      
      loadQuestionsForTopic(currentTopicKey);
    }

    // ---------- Question Loading ----------

    async function loadQuestionsForTopic(topicKey) {
      const topic = TOPICS[topicKey];
      if (!topic) return;

      try {
        removeTimerNotification();
        
        questionTextEl.textContent = "Loading questions from Google Sheet‚Ä¶";
        optionsListEl.innerHTML = "";
        feedbackEl.textContent = "";
        submitBtn.disabled = true;
        nextBtn.disabled = true;
        previousBtn.disabled = true;
        finishBtn.disabled = true;
        finalScoreEl.style.display = "none";
        progressBarFillEl.style.width = "0%";
        questionCounterEl.textContent = "Loading‚Ä¶";

        timerContainerEl.style.display = "none";

        const res = await fetch(topic.url);
        if (!res.ok) throw new Error("Network error");
        const text = await res.text();
        const parsed = parseCSV(text);

        if (parsed.length === 0) {
          questionTextEl.textContent = "No questions found in this sheet.";
          questionsLoaded = false;
          return;
        }

        questions = prepareQuestionBank(parsed);
        userAnswers = new Array(questions.length);

        questionsLoaded = true;
        currentIndex = 0;
        score = 0;
        scoreMiniEl.textContent = "Score: 0";
        submitBtn.style.display = "inline-block";
        nextBtn.style.display = "inline-block";
        previousBtn.style.display = "inline-block";
        finishBtn.style.display = "inline-block";
        
        // Update topic display
        currentTopicKey = topicKey;
        quizTopicNameEl.textContent = topic.name;
        quizQuestionCountEl.textContent = `${questions.length} questions`;
        
        // Update header badge
        if (window.quizLogin && window.quizLogin.updateTopicBadge) {
          window.quizLogin.updateTopicBadge(topic.name, questions.length);
        }
        
        if (timeLimitSet && topicTimeLimit > 0) {
          showTimerNotification();
          startTopicTimer();
        }
        
        renderQuestion();
      } catch (err) {
        console.error(err);
        questionTextEl.textContent = "Error loading questions. Check CSV link, sharing & internet.";
        submitBtn.disabled = true;
        nextBtn.disabled = true;
        previousBtn.disabled = true;
        finishBtn.disabled = true;
      }
    }

    // ---------- Event Listeners ----------

    submitBtn.addEventListener("click", () => {
      if (!questionsLoaded || hasAnswered) return;

      const selectedIndex = getSelectedOptionIndex();
      if (selectedIndex === -1) {
        alert("Please select an option before submitting.");
        return;
      }

      const q = questions[currentIndex];
      hasAnswered = true;
      userAnswers[currentIndex] = selectedIndex;

      if (selectedIndex === q.correctIndex) {
        score++;
        feedbackEl.textContent = "‚úÖ Correct!";
        feedbackEl.className = "feedback correct";
      } else {
        feedbackEl.textContent = `‚ùå Wrong. Correct answer: ${q.options[q.correctIndex]}`;
        feedbackEl.className = "feedback incorrect";
      }

      scoreMiniEl.textContent = `Score: ${score}`;
      showCorrectness(selectedIndex);
      lockOptions();
      submitBtn.disabled = true;

      if (selectedIndex === q.correctIndex) {
        nextBtn.disabled = true;
        setTimeout(() => {
          nextBtn.disabled = false;
          goToNextQuestion();
        }, 700);
      }
    });

    nextBtn.addEventListener("click", () => {
      goToNextQuestion();
    });

    previousBtn.addEventListener("click", () => {
      goToPreviousQuestion();
    });

    finishBtn.addEventListener("click", () => {
      if (confirm("Are you sure you want to finish the quiz? Your current score will be calculated.")) {
        showFinalResults();
      }
    });

    startBtnEl.addEventListener("click", () => {
      const key = topicSelectEl.value;
      if (!key) {
        alert("Please select a topic first.");
        return;
      }
      
      stopTimer();
      removeTimerNotification();
      
      currentTopicKey = key;
      loadQuestionsForTopic(key);
    });

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize login
      window.quizLogin = new QuizLogin();
    });
  </script>
</body>
</html>
